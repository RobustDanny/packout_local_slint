import { Button, VerticalBox, GridBox, StandardTableView, LineEdit, HorizontalBox, ComboBox, StandardListView } from "std-widgets.slint";
import {DropDownMenu, NavigationBar, SearchBar, IconButton, MaterialWindow,
    FilledButton, ElevatedCard ,SmallAppBar, HorizontalDivider, TabBar, LargeAppBar, SegmentedButton, TonalButton, ScrollView} from "material.slint";

import "./fonts/Montserrat/Montserrat-Regular.ttf";
import "./fonts/Montserrat/Montserrat-Medium.ttf";

struct ResidentData{
    id: int,
    apt: string,
    first_name: string,
    last_name: string,
    linked: bool,
}

struct CardData{
    id: int,
    resident_id: int,
    apt: string,
    added_date: string,
    hash: string,
}

struct LogData{
    id: int,
    action_type: string,
    action: string,
    date_time: string,
}

struct PackageData {
    id: int,
    apt: string,
    package_number: string,
    barcode: string,
    comment: string,
    date_time: string,
}

component ModernCard inherits Rectangle {
    in property <string> title;
    in property <string> content;
    in property <color> accent: #3B82F6;

    border-radius: 16px;
    background: white;
    drop-shadow-blur: 16px;
    drop-shadow-color: #00000008;
    
    VerticalBox {
        padding: 24px;
        spacing: 8px;
        
        Text {
            font-weight: 600;
            font-size: 14px;
            text: title;
            color: #1F2937;
        }
        Text {
            text: content;
            color: #6B7280;
            font-size: 14px;
        }
    }
}

component ModernButton inherits Rectangle {
    in property <string> text;
    in property <bool> primary: true;
    in property <bool> enabled: true;
    callback clicked;
    
    width: 120px;
    height: 44px;
    border-radius: 12px;
    background: primary ? (touch.pressed ? #2563EB : (touch.has-hover ? #3B82F6 : #3B82F6)) : 
                (touch.pressed ? #F3F4F6 : (touch.has-hover ? #E5E7EB : #F9FAFB));
    
    touch := TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
    }
    
    HorizontalBox {
        alignment: center;
        Text {
            text: root.text;
            color: primary ? white : #374151;
            font-size: 14px;
            font-weight: 600;
        }
    }
}

component ModernInput inherits Rectangle {
    in property <string> placeholder;
    in-out property <string> text;
    callback edited(string);
    callback accepted(string);
    
    height: 48px;
    border-radius: 12px;
    background: white;
    border-width: 2px;
    border-color: input.has-focus ? #3B82F6 : #E5E7EB;
    
    input := LineEdit {
        placeholder-text: placeholder;
        text <=> root.text;
        font-size: 14px;
        edited(t) => { root.edited(t); }
        accepted(t) => { root.accepted(t); }
    }
}

component Badge inherits Rectangle {
    in property <string> text;
    in property <color> bg: #DBEAFE;
    in property <color> fg: #1E40AF;
    
    height: 28px;
    border-radius: 14px;
    background: bg;
    
    HorizontalBox {
        padding-left: 12px;
        padding-right: 12px;
        alignment: center;
        
        Text {
            text: root.text;
            color: fg;
            font-size: 12px;
            font-weight: 600;
        }
    }
}

export component AppWindow inherits MaterialWindow {

    in-out property <[PackageData]> unassigned_packages: [];
    in-out property <int> scan_count: 0;
    in-out property <bool> show_assign_mode: false;
    in-out property <int> selected_package_index: -1;
    in-out property <string> current_apt: "";
    in-out property <string> individual_apt: "";
    in-out property <string> individual_comment: "";
    in-out property <int> package_sequence: 1;
    in-out property <string> scanned_barcode: "";
    in-out property <bool> scanning_active: false;

    out property <bool> show_resident_form: false;
    out property <bool> show_link_card_form: false;
    in-out property <bool> show_verification: false;
    in-out property <bool> show_resident_info: false;
    in-out property <bool> show_card_info: false;
    in-out property <bool> show_log_info: false;

    out property <bool> show_package_form: false;
    out property <bool> show_package_info: false;
    out property <bool> show_collection_mode: false;
    
    in-out property <int> current_tab: 0;

    in-out property <string> verification_status: "";
    in-out property <string> last_verified_name: "";
    in-out property <string> last_verified_apt: "";
    in-out property <string> info_alert: "";

    in-out property <int> verification_type: 0;

    in-out property <bool> inventory: false;
    
    in-out property <[string]> resident_list: [];
    in-out property <int> selected_resident_index: -1;
    
    changed selected_resident_index => {
        if (selected_resident_index >= 0) {
            root.resident_info = get_resident_at_index(selected_resident_index);
        }
    }

    in-out property <PackageData> package: {
        apt: "",
        package_number: "",
        barcode: "",
        comment: "",
        date_time: "",
    };
    
    in-out property <PackageData> package_info: {
        id: 0,
        apt: "",
        package_number: "",
        barcode: "",
        comment: "",
        date_time: "",
    };

    in-out property <CardData> card: {
        apt: "",
        added_date: "",
    };
    in-out property <CardData> card_info: {
        resident_id: 0,
        apt: "",
        added_date: "",
        hash: "",
    };
    in-out property <LogData> log: {
        action_type: "",
        action: "",
        date_time: "",
    };
    in-out property <LogData> log_info: {
        action_type: "",
        action: "",
        date_time: "",
    };
    in-out property <ResidentData> resident: {
        apt: "",
        first_name: "",
        last_name: "",
        linked: false,
    };
    in-out property <ResidentData> resident_info: {
        apt: "",
        first_name: "",
        last_name: "",
        linked: false,
    };
    in-out property <[[StandardListViewItem]]> residents_data: [[]];
    in-out property <[[StandardListViewItem]]> cards_data: [[]];
    in-out property <[[StandardListViewItem]]> logs_data: [[]];
    in-out property <[TableColumn]> table_columns: [
        {title: "ID"},
        {title: "Apt"},
        {title: "First Name"},
        {title: "Last Name"},
        {title: "Linked"},
    ];

    in-out property <[[StandardListViewItem]]> packages_data: [[]];
    in-out property <int> package_count: 0;
    
    callback quick_scan_package(string, string);  // barcode, comment
    callback assign_apartment_to_package(int, string);  // index, apartment
    callback assign_comment_to_package(int, string);  // index, comment
    callback bulk_assign_apartment(string);  // Assign to all unassigned
    callback save_assigned_packages();  // Save all to database
    callback clear_scanned_packages();

    callback add_package(PackageData);
    callback show_packages_data();
    callback show_one_package_info(int);
    callback search_packages(string, int);
    callback start_collection_mode();
    callback collect_package_with_card(int, string) -> string;

    callback add_resident(ResidentData);
    callback add_card(CardData);
    callback add_log();

    callback show_one_resident_info(int);
    callback show_one_card_info(int);
    callback show_one_log_info(int);
    callback search_residents(string, int);
    callback search_cards(string, int);
    callback search_logs(string, int);

    callback remove_resident(int);

    callback show_residents_data();
    callback show_card_data();
    callback show_log_data();
    
    callback read_nfc_card() -> string;
    callback link_card_to_resident(int, string) -> string;
    callback get_resident_at_index(int) -> ResidentData;

    background: #FFFEFC;
    width: 1200px;
    height: 1000px;
    padding: 20px;
    title: "Packout";
    icon: @image-url("icons/package-box.svg");
    default-font-family: "Montserrat";
    default-font-size: 13px;
    default-font-weight: 700;
    full-screen: true;

    // Info Alert
    if info_alert != "" : Rectangle {
        width: 100%;
        height: 100%;
        z: 100;
        
        TouchArea {
            clicked => {
                root.info_alert = "";
            }
        }
        
        Rectangle { 
            width: 400px;
            height: 200px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: root.info_alert == "Card Linked successfully" ? #ECFDF5 : #FEF2F2;
            border-radius: 12px;
            border-width: 1px;
            border-color: root.info_alert == "Card Linked successfully" ? #10B981 : #EF4444;
            drop-shadow-color: #00000050;
            
            VerticalBox {
                padding: 30px;
                alignment: center;
                spacing: 25px;
                
                Text {
                    text: root.info_alert;
                    font-size: 16px;
                    font-weight: 600;
                    wrap: word-wrap;
                    horizontal-alignment: center;
                    color:  root.info_alert == "Card Linked successfully" ? #065F46 : #991B1B;
                }
            }
        }
    }

    // Resident Info Form
    ElevatedCard {
        visible: root.show_resident_form;
        width: 400px;
        height: 500px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Add New Resident";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "Apartment Number:";
                        font-weight: 700;
                        font-size: 14px;
                    }
                    LineEdit {
                        placeholder-text: "e.g., 101";
                        height: 45px;
                        edited(new_text) => {
                            resident.apt = new_text;
                        }
                    }
                }
                
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "First Name:";
                        font-weight: 700;
                        font-size: 14px;
                    }
                    LineEdit {
                        placeholder-text: "Enter first name";
                        height: 45px;
                        edited(new_text) => {
                            resident.first_name = new_text;
                        }
                    }
                }
                
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "Last Name:";
                        font-weight: 700;
                        font-size: 14px;
                    }
                    LineEdit {
                        placeholder-text: "Enter last name";
                        height: 45px;
                        edited(new_text) => {
                            resident.last_name = new_text;
                        }
                    }
                }
            }
            
            Rectangle {
                height: 10px;
            }
            
            HorizontalBox {
                alignment: center;
                spacing: 15px;
                
                FilledButton {
                    height: 50px;
                    width: 150px;
                    text: "Add Resident";
                    enabled: resident.apt != "" && resident.first_name != "" && resident.last_name != "";
                    clicked() => {
                        add_resident(resident);
                        root.show_resident_form = false;
                        resident.apt = "";
                        resident.first_name = "";
                        resident.last_name = "";
                    }
                }
                
                FilledButton {
                    height: 50px;
                    width: 150px;
                    text: "Cancel";
                    clicked() => {
                        root.show_resident_form = false;
                        resident.apt = "";
                        resident.first_name = "";
                        resident.last_name = "";
                    }
                }
            }
        }
    }

    // Link Card Form
    ElevatedCard {
        visible: root.show_link_card_form;
        width: 400px;
        height: 550px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Link Card to Resident";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                Text {
                    text: "Select Resident:";
                    font-weight: 700;
                    font-size: 14px;
                }
                
                ComboBox {
                    model: resident_list;
                    current-index <=> selected_resident_index;
                    current-value: selected_resident_index >= 0 ? resident_list[selected_resident_index] : "-- Select a resident --";
                    selected(value) => {
                        if (selected_resident_index >= 0) {
                            root.resident_info = get_resident_at_index(selected_resident_index);
                        }
                    }
                }
                
                if selected_resident_index >= 0 : VerticalBox {
                    spacing: 10px;
                    
                    Rectangle {
                        height: 1px;
                        background: #E0E0E0;
                    }
                    
                    HorizontalBox {
                        Text {
                            text: "Resident:";
                            font-weight: 700;
                            width: 100px;
                        }
                        Text {
                            text: resident_info.first_name + " " + resident_info.last_name;
                        }
                    }
                    
                    HorizontalBox {
                        Text {
                            text: "Apartment:";
                            font-weight: 700;
                            width: 100px;
                        }
                        Text {
                            text: resident_info.apt;
                        }
                    }
                }
            }
            
            Rectangle {
                height: 10px;
            }
            
            VerticalBox {
                spacing: 10px;
                
                Text {
                    text: "Instructions:";
                    font-weight: 700;
                    font-size: 16px;
                }
                
                Text {
                    text: "1. Select a resident from the list above";
                    horizontal-alignment: left;
                }
                
                Text {
                    text: "2. Click 'Scan & Link Card' button";
                    horizontal-alignment: left;
                }
                
                Text {
                    text: "3. Place NFC card on the reader";
                    horizontal-alignment: left;
                }
                
                Text {
                    text: "4. Keep card on reader until complete";
                    horizontal-alignment: left;
                }
            }
            
            Rectangle {
                height: 10px;
            }
            HorizontalBox {
                alignment: center;
                spacing: 15px;
                
                FilledButton {
                    height: 50px;
                    width: 150px;
                    text: "Scan & Link";
                    enabled: selected_resident_index >= 0;
                    clicked() => {
                        if (selected_resident_index >= 0) {
                            let result = link_card_to_resident(resident_info.id, resident_info.apt);
                            
                            if (result == "Success! Card linked.") {
                                root.show_link_card_form = false;
                                root.selected_resident_index = -1;
                            }
                        }
                    }
                }

                FilledButton {
                    height: 50px;
                    width: 150px;
                    text: "Cancel";
                    clicked() => {
                        root.show_link_card_form = false;
                        root.selected_resident_index = -1;
                        root.resident_info = {
                            id: 0,
                            apt: "",
                            first_name: "",
                            last_name: "",
                            linked: false,
                        };
                    }
                }
            }
        }
    }

    // Resident Info
    ElevatedCard {
        visible: root.show_resident_info;
        width: 450px;
        height: 400px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Resident Information";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Apartment:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Text {
                        text: resident_info.apt;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "First Name:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Text {
                        text: resident_info.first_name;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Last Name:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Text {
                        text: resident_info.last_name;
                        font-size: 14px;
                    }
                }
                
                Rectangle {
                    height: 1px;
                    background: #E0E0E0;
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Card Linked:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    
                    Rectangle {
                        width: 80px;
                        height: 30px;
                        border-radius: 15px;
                        background: resident_info.linked ? #4CAF50 : #F44336;
                        HorizontalBox {
                            alignment: center;
                            Text {
                                text: resident_info.linked ? "Yes" : "No";
                                color: white;
                                font-weight: 700;
                                font-size: 12px;
                            }
                        }
                    }
                }
            }
            
            Rectangle {
                height: 20px;
            }
            
            HorizontalBox {
                alignment: center;
                spacing: 15px;
                
                FilledButton {
                    text: "Update";
                    width: 120px;
                    height: 45px;
                    clicked() => {}
                }
                
                FilledButton {
                    text: "Remove";
                    width: 120px;
                    height: 45px;
                    clicked() => {
                        root.show_resident_info = false;
                        remove_resident(resident_info.id);                        
                    }
                }
            }
        }
    }

    ElevatedCard {
        visible: root.show_package_form && !root.show_assign_mode;
        width: 700px;
        height: 750px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalLayout {
            padding: 30px;
            spacing: 15px;
            
            // Header with counter
            HorizontalLayout {
                alignment: space-between;
                
                VerticalLayout {
                    spacing: 5px;
                    Text { 
                        text: "⚡ Quick Scan Mode";
                        font-size: 24px;
                        font-weight: 700;
                        color: #FF6F00;
                    }
                    Text {
                        text: "Scan all packages first, assign apartments later";
                        font-size: 13px;
                        color: #666;
                    }
                }
                
                Rectangle {
                    width: 120px;
                    height: 60px;
                    border-radius: 12px;
                    background: #4CAF50;
                    
                    VerticalLayout {
                        alignment: center;
                        spacing: 5px;
                        
                        Text {
                            text: root.scan_count;
                            font-size: 32px;
                            font-weight: 700;
                            color: white;
                        }
                        Text {
                            text: "Scanned";
                            font-size: 11px;
                            color: white;
                        }
                    }
                }
            }
            
            Rectangle {
                height: 2px;
                background: #E0E0E0;
            }
            
            // Large Scanning Area
            Rectangle {
                height: 150px;
                border-radius: 16px;
                background: #E3F2FD;
                border-width: 4px;
                border-color: #2196F3;
                
                VerticalLayout {
                    padding: 20px;
                    spacing: 15px;
                    alignment: center;
                    
                    Text {
                        text: "🔦 SCAN BARCODE";
                        font-size: 20px;
                        font-weight: 700;
                        color: #1976D2;
                    }
                    
                    LineEdit {
                        placeholder-text: "Click here and scan continuously...";
                        text <=> root.scanned_barcode;
                        height: 60px;
                        font-size: 20px;
                        accepted(text) => {
                            if (text != "") {
                                // Get current comment (if any)
                                let comment = package.comment;
                                
                                // Auto-save scanned package
                                quick_scan_package(text, comment);
                                
                                // Increment counter
                                root.scan_count = root.scan_count + 1;
                                
                                // Clear barcode field immediately
                                root.scanned_barcode = "";
                                
                                // Clear comment field ONLY if it was used
                                if (comment != "") {
                                    package.comment = "";
                                }
                            }
                        }
                    }
                    
                    HorizontalLayout {
                        spacing: 15px;
                        alignment: center;
                        
                        Text {
                            text: "💡 Scan → Auto-adds → Keep scanning!";
                            font-size: 12px;
                            color: #1976D2;
                            font-weight: 700;
                        }
                        
                        Text {
                            text: "Comment applies to NEXT scan";
                            font-size: 12px;
                            color: #FF6F00;
                            font-weight: 700;
                        }
                    }
                }
            }
            
            // Optional Comment Field
            VerticalLayout {
                spacing: 8px;
                
                HorizontalLayout {
                    spacing: 10px;
                    alignment: space-between;
                    
                    Text {
                        text: "📝 Add Note for NEXT Package:";
                        font-weight: 700;
                        font-size: 14px;
                        color: #FF6F00;
                    }
                    
                    if package.comment != "" : Rectangle {
                        height: 40px;
                        border-radius: 8px;
                        background: #FFF3E0;
                        border-width: 2px;
                        border-color: #FF9800;
                        
                        HorizontalLayout {
                            padding: 10px;
                            spacing: 10px;
                            alignment: center;
                            
                            Text {
                                text: "⚡ Next scan will include:";
                                font-size: 11px;
                                color: #E65100;
                                font-weight: 700;
                            }
                            
                            Text {
                                text: "\"" + package.comment + "\"";
                                font-size: 11px;
                                color: #F57F17;
                            }
                        }
                    }
                }
                
                HorizontalLayout {
                    spacing: 10px;
                    
                    LineEdit {
                        placeholder-text: "e.g., Fragile, Large, Heavy...";
                        text: package.comment;
                        height: 45px;
                        edited(new_text) => {
                            package.comment = new_text;
                        }
                    }
                    
                    FilledButton {
                        text: "Clear";
                        width: 80px;
                        height: 45px;
                        visible: package.comment != "";
                        clicked() => {
                            package.comment = "";
                        }
                    }
                }
                
                Text {
                    text: "💡 Type comment BEFORE scanning the package that needs it";
                    font-size: 10px;
                    color: #FF6F00;
                    font-weight: 700;
                }
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            // Scanned packages list preview
            VerticalLayout {
                spacing: 10px;
                
                HorizontalLayout {
                    alignment: space-between;
                    
                    Text {
                        text: "📋 Scanned Packages:";
                        font-weight: 700;
                        font-size: 14px;
                    }
                    
                    if root.scan_count > 0 : Text {
                        text: root.scan_count + " packages ready";
                        font-size: 12px;
                        color: #4CAF50;
                        font-weight: 700;
                    }
                }
                
                ScrollView {
                    height: 200px;
                    
                    VerticalLayout {
                        spacing: 8px;
                        
                        if root.scan_count == 0 : Rectangle {
                            height: 100px;
                            VerticalLayout {
                                alignment: center;
                                Text {
                                    text: "No packages scanned yet";
                                    color: #999;
                                    font-size: 14px;
                                }
                                Text {
                                    text: "Click in the blue field above and start scanning!";
                                    color: #BBB;
                                    font-size: 12px;
                                }
                            }
                        }
                        
                        // List of scanned packages
                        for pkg[index] in unassigned_packages : Rectangle {
                            height: 50px;
                            border-radius: 8px;
                            background: #F5F5F5;
                            border-width: 1px;
                            border-color: #E0E0E0;
                            
                            HorizontalLayout {
                                padding: 12px;
                                spacing: 15px;
                                alignment: space-between;
                                
                                HorizontalLayout {
                                    spacing: 15px;
                                    
                                    Text {
                                        text: "#" + (index + 1);
                                        font-weight: 700;
                                        color: #2196F3;
                                        width: 40px;
                                    }
                                    
                                    Text {
                                        text: pkg.barcode;
                                        font-family: "monospace";
                                        font-size: 12px;
                                    }
                                    
                                    if pkg.comment != "" : Rectangle {
                                        height: 24px;
                                        border-radius: 12px;
                                        background: #FFF9C4;
                                        HorizontalLayout {
                                            padding-left: 10px;
                                            padding-right: 10px;
                                            alignment: center;
                                            Text {
                                                text: pkg.comment;
                                                font-size: 10px;
                                                color: #F57F17;
                                            }
                                        }
                                    }
                                }
                                
                                Text {
                                    text: "⏳ Unassigned";
                                    font-size: 11px;
                                    color: #FF9800;
                                }
                            }
                        }
                    }
                }
            }
            
            // Bottom Actions
            HorizontalLayout {
                alignment: space-between;
                spacing: 15px;
                
                FilledButton {
                    text: "Clear All";
                    width: 120px;
                    height: 50px;
                    visible: root.scan_count > 0;
                    clicked() => {
                        clear_scanned_packages();
                        root.scan_count = 0;
                    }
                }
                
                HorizontalLayout {
                    spacing: 10px;
                    
                    FilledButton {
                        text: "Next: Assign Apartments →";
                        width: 220px;
                        height: 50px;
                        enabled: root.scan_count > 0;
                        clicked() => {
                            root.show_assign_mode = true;
                        }
                    }
                    
                    FilledButton {
                        text: "Cancel";
                        width: 100px;
                        height: 50px;
                        clicked() => {
                            root.show_package_form = false;
                            clear_scanned_packages();
                            root.scan_count = 0;
                        }
                    }
                }
            }
        }
    }
    
    // STEP 2: Assignment Mode - Assign apartments to scanned packages
    ElevatedCard {
        visible: root.show_package_form && root.show_assign_mode;
        width: 900px;
        height: 700px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalLayout {
            padding: 30px;
            spacing: 20px;
            
            // Header
            HorizontalLayout {
                alignment: space-between;
                
                VerticalLayout {
                    spacing: 5px;
                    Text { 
                        text: "📍 Assign Apartments";
                        font-size: 24px;
                        font-weight: 700;
                        color: #1976D2;
                    }
                    Text {
                        text: "Assign apartment numbers to scanned packages";
                        font-size: 13px;
                        color: #666;
                    }
                }
                
                FilledButton {
                    text: "← Back to Scanning";
                    width: 180px;
                    height: 45px;
                    clicked() => {
                        root.show_assign_mode = false;
                    }
                }
            }
            
            Rectangle {
                height: 2px;
                background: #E0E0E0;
            }
            
            HorizontalLayout {
                spacing: 30px;
                alignment: stretch;
                
                // Left: Package List
                VerticalLayout {
                    width: 500px;
                    spacing: 15px;
                    
                    Text {
                        text: "Packages (" + root.scan_count + ")";
                        font-weight: 700;
                        font-size: 16px;
                    }
                    
                    ScrollView {
                        height: 500px;
                        
                        VerticalLayout {
                            spacing: 10px;
                            
                            for pkg[index] in unassigned_packages : Rectangle {
                                height: 80px;
                                border-radius: 10px;
                                background: pkg.apt == "" ? #FFEBEE : #E8F5E9;
                                border-width: 2px;
                                border-color: pkg.apt == "" ? #FF5252 : #4CAF50;
                                
                                TouchArea {
                                    clicked => {
                                        root.selected_package_index = index;
                                    }
                                }
                                
                                VerticalLayout {
                                    padding: 12px;
                                    spacing: 8px;
                                    
                                    HorizontalLayout {
                                        alignment: space-between;
                                        
                                        Text {
                                            text: "Package #" + (index + 1);
                                            font-weight: 700;
                                            font-size: 14px;
                                        }
                                        
                                        if pkg.apt == "" : Rectangle {
                                            width: 100px;
                                            height: 24px;
                                            border-radius: 12px;
                                            background: #FF5252;
                                            HorizontalLayout {
                                                alignment: center;
                                                Text {
                                                    text: "⏳ Pending";
                                                    color: white;
                                                    font-size: 11px;
                                                    font-weight: 700;
                                                }
                                            }
                                        }
                                        
                                        if pkg.apt != "" : Rectangle {
                                            width: 100px;
                                            height: 24px;
                                            border-radius: 12px;
                                            background: #4CAF50;
                                            HorizontalLayout {
                                                alignment: center;
                                                Text {
                                                    text: "✓ Apt " + pkg.apt;
                                                    color: white;
                                                    font-size: 11px;
                                                    font-weight: 700;
                                                }
                                            }
                                        }
                                    }
                                    
                                    Text {
                                        text: pkg.barcode;
                                        font-family: "monospace";
                                        font-size: 12px;
                                        color: #666;
                                    }
                                    
                                    if pkg.comment != "" : Text {
                                        text: "📝 " + pkg.comment;
                                        font-size: 11px;
                                        color: #999;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Right: Assignment Panel
                VerticalLayout {
                    spacing: 20px;
                    
                    // Bulk Assignment
                    ElevatedCard {
                        VerticalLayout {
                            padding: 20px;
                            spacing: 15px;
                            
                            Text {
                                text: "🚀 Quick Assign";
                                font-weight: 700;
                                font-size: 16px;
                            }
                            
                            Text {
                                text: "Assign same apartment to all packages:";
                                font-size: 12px;
                                color: #666;
                            }
                            
                            HorizontalLayout {
                                spacing: 10px;
                                
                                LineEdit {
                                    placeholder-text: "Enter apartment";
                                    text: root.current_apt;
                                    height: 50px;
                                    font-size: 18px;
                                    edited(new_text) => {
                                        root.current_apt = new_text;
                                    }
                                }
                                
                                FilledButton {
                                    text: "Assign All";
                                    width: 120px;
                                    height: 50px;
                                    enabled: root.current_apt != "";
                                    clicked() => {
                                        bulk_assign_apartment(root.current_apt);
                                        root.current_apt = "";
                                    }
                                }
                            }
                        }
                    }
                    
                    // Individual Assignment
                    ElevatedCard {
                        VerticalLayout {
                            padding: 20px;
                            spacing: 15px;
                            
                            Text {
                                text: "📍 Assign Individual";
                                font-weight: 700;
                                font-size: 16px;
                            }
                            
                            if root.selected_package_index >= 0 : VerticalLayout {
                                spacing: 10px;
                                
                                Text {
                                    text: "Selected: Package #" + (root.selected_package_index + 1);
                                    font-size: 12px;
                                    color: #666;
                                }
                                
                                VerticalLayout {
                                    spacing: 10px;
                                    
                                    Text {
                                        text: "Apartment:";
                                        font-size: 11px;
                                        font-weight: 700;
                                    }
                                    
                                    HorizontalLayout {
                                        spacing: 10px;
                                        
                                        LineEdit {
                                            placeholder-text: "Enter apartment";
                                            text <=> root.individual_apt;
                                            height: 45px;
                                            font-size: 16px;
                                            // Handle Enter key press
                                            accepted(text) => {
                                                if text != "" && root.selected_package_index >= 0 {
                                                    root.assign_apartment_to_package(root.selected_package_index, text);
                                                    root.individual_apt = "";
                                                }
                                            }
                                        }
                                        
                                        FilledButton {
                                            text: "Set";
                                            width: 80px;
                                            height: 45px;
                                            enabled: root.individual_apt != "" && root.selected_package_index >= 0;
                                            clicked() => {
                                                if root.individual_apt != "" && root.selected_package_index >= 0 {
                                                    // Direct callback invocation
                                                    root.assign_apartment_to_package(root.selected_package_index, root.individual_apt);
                                                    root.individual_apt = "";
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                VerticalLayout {
                                    spacing: 10px;
                                    
                                    Text {
                                        text: "Comment (optional):";
                                        font-size: 11px;
                                        font-weight: 700;
                                    }
                                    
                                    HorizontalLayout {
                                        spacing: 10px;
                                        
                                        LineEdit {
                                            placeholder-text: "Add/edit comment";
                                            text <=> root.individual_comment;
                                            height: 45px;
                                            // Handle Enter key press
                                            accepted(text) => {
                                                if root.selected_package_index >= 0 {
                                                    root.assign_comment_to_package(root.selected_package_index, text);
                                                    root.individual_comment = "";
                                                }
                                            }
                                        }
                                        
                                        FilledButton {
                                            text: "Set";
                                            width: 80px;
                                            height: 45px;
                                            enabled: root.selected_package_index >= 0;
                                            clicked() => {
                                                if root.selected_package_index >= 0 {
                                                    // Direct callback invocation
                                                    root.assign_comment_to_package(root.selected_package_index, root.individual_comment);
                                                    root.individual_comment = "";
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                FilledButton {
                                    text: "✓ Done with this package";
                                    width: 100%;
                                    height: 40px;
                                    clicked() => {
                                        root.selected_package_index = -1;
                                        root.individual_apt = "";
                                        root.individual_comment = "";
                                    }
                                }
                            }
                            
                            if root.selected_package_index < 0 : VerticalLayout {
                                spacing: 10px;
                                alignment: center;
                                
                                Rectangle {
                                    height: 100px;
                                    VerticalLayout {
                                        alignment: center;
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "👈 Click a package";
                                            font-size: 18px;
                                            color: #999;
                                        }
                                        
                                        Text {
                                            text: "Select a package from the list to assign apartment";
                                            font-size: 12px;
                                            color: #BBB;
                                            horizontal-alignment: center;
                                            wrap: word-wrap;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Completion
                    ElevatedCard {
                        VerticalLayout {
                            padding: 20px;
                            spacing: 15px;
                            alignment: center;
                            
                            Text {
                                text: "✅ Complete Assignment";
                                font-weight: 700;
                                font-size: 16px;
                            }
                            
                            FilledButton {
                                text: "Save All Packages";
                                width: 200px;
                                height: 55px;
                                clicked() => {
                                    // Save all assigned packages to database
                                    save_assigned_packages();
                                    
                                    // Close forms and reset
                                    root.show_package_form = false;
                                    root.show_assign_mode = false;
                                    root.scan_count = 0;
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // Package Info Display
    ElevatedCard {
        visible: root.show_package_info;
        width: 500px;
        height: 450px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Package Information";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Package ID:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 150px;
                    }
                    Text {
                        text: package_info.id;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Apartment:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 150px;
                    }
                    Text {
                        text: package_info.apt;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Package Number:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 150px;
                    }
                    Text {
                        text: package_info.package_number;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Tracking Number:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 150px;
                    }
                    Text {
                        text: package_info.comment != "" ? package_info.comment : "N/A";
                        font-size: 12px;
                        font-family: "monospace";
                        color: #666;
                        wrap: word-wrap;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Received:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 150px;
                    }
                    Text {
                        text: package_info.date_time;
                        font-size: 14px;
                    }
                }
            }
            
            Rectangle {
                height: 20px;
            }
            
            HorizontalBox {
                alignment: center;
                spacing: 15px;
                
                FilledButton {
                    text: "Print Label";
                    width: 140px;
                    height: 45px;
                    clicked() => {}
                }
                
                FilledButton {
                    text: "Close";
                    width: 140px;
                    height: 45px;
                    clicked() => {
                        root.show_package_info = false;
                    }
                }
            }
        }
    }

    // Card Info
    ElevatedCard {
        visible: root.show_card_info;
        width: 500px;
        height: 450px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Card Information";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Card ID:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 130px;
                    }
                    Text {
                        text: card_info.id;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Resident ID:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 130px;
                    }
                    Text {
                        text: card_info.resident_id;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Apartment:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 130px;
                    }
                    Text {
                        text: card_info.apt;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Added Date:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 130px;
                    }
                    Text {
                        text: card_info.added_date;
                        font-size: 14px;
                    }
                }
                
                Rectangle {
                    height: 1px;
                    background: #E0E0E0;
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Card Hash:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 130px;
                    }
                    Text {
                        text: card_info.hash;
                        font-size: 12px;
                        font-family: "monospace";
                        color: #666;
                    }
                }
            }
            
            Rectangle {
                height: 20px;
            }
            
            HorizontalBox {
                alignment: center;
                spacing: 15px;
                
                FilledButton {
                    text: "Unlink Card";
                    width: 140px;
                    height: 45px;
                    clicked() => {}
                }
                
                FilledButton {
                    text: "Close";
                    width: 140px;
                    height: 45px;
                    clicked() => {
                        root.show_card_info = false;
                    }
                }
            }
        }
    }

    // Log Info
    ElevatedCard {
        visible: root.show_log_info;
        width: 550px;
        height: 420px;
        z: 1;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        
        VerticalBox {
            padding: 30px;
            spacing: 20px;
            alignment: center;
            
            Text { 
                text: "Log Entry Details";
                font-size: 20px;
                font-weight: 700;
            }
            
            Rectangle {
                height: 1px;
                background: #E0E0E0;
            }
            
            VerticalBox {
                spacing: 15px;
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Log ID:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Text {
                        text: log_info.id;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Date & Time:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Text {
                        text: log_info.date_time;
                        font-size: 14px;
                    }
                }
                
                HorizontalBox {
                    spacing: 10px;
                    Text {
                        text: "Action Type:";
                        font-weight: 700;
                        font-size: 14px;
                        width: 120px;
                    }
                    Rectangle {
                        width: 100px;
                        height: 28px;
                        border-radius: 14px;
                        background: log_info.action_type == "verified" ? #4CAF50 : 
                                   log_info.action_type == "linked" ? #2196F3 : 
                                   log_info.action_type == "remove" ? #F44336 : #9E9E9E;
                        HorizontalBox {
                            alignment: center;
                            Text {
                                text: log_info.action_type;
                                color: white;
                                font-weight: 700;
                                font-size: 12px;
                            }
                        }
                    }
                }
                
                Rectangle {
                    height: 1px;
                    background: #E0E0E0;
                }
                
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "Action Details:";
                        font-weight: 700;
                        font-size: 14px;
                    }
                    Rectangle {
                        height: 90px;
                        border-radius: 8px;
                        background: #F5F5F5;
                        border-width: 1px;
                        border-color: #E0E0E0;
                        
                        VerticalBox {
                            padding: 12px;
                            Text {
                                text: log_info.action;
                                font-size: 13px;
                                color: #424242;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
            }
        }
    }

    // Background overlay for modals
    if root.show_link_card_form || root.show_resident_form || root.show_resident_info || 
       root.show_card_info || root.show_log_info || root.show_package_form || root.show_package_info : TouchArea {
        width: 100%; 
        height: 100%;
        z: 0;
        clicked => { 
            root.show_link_card_form = false;
            root.show_resident_form = false;
            root.show_resident_info = false;
            root.show_card_info = false;
            root.show_log_info = false;
            root.show_package_form = false;
            root.show_package_info = false;
        }
    }

    if info_alert != "" : TouchArea {
        width: 100%;
        height: 100%;
        z: 0;
        clicked => {
            root.info_alert = "";
        }
    }

    // Inventory Mode Overlay
    if root.inventory : Rectangle {
        width: 100%;
        height: 100%;
        background: #F5F5F5;
        z: 50;
        
        VerticalBox {
            padding: 40px;
            alignment: start;
            spacing: 30px;
            
            HorizontalBox {
                alignment: space-between;
                
                VerticalBox {
                    spacing: 10px;
                    Text {
                        text: "Package Collection Station";
                        font-size: 28px;
                        font-weight: 700;
                        color: #1976D2;
                    }
                    Text {
                        text: "Tap your card to collect packages";
                        font-size: 16px;
                        color: #666;
                    }
                }
                
                FilledButton {
                    text: "Exit Collection Mode";
                    width: 200px;
                    height: 50px;
                    clicked => {
                        root.inventory = false;
                    }
                }
            }
            
            Rectangle {
                height: 2px;
                background: #E0E0E0;
            }
            
            HorizontalBox {
                spacing: 30px;
                alignment: stretch;
                
                ElevatedCard {
                    width: 500px;
                    
                    VerticalBox {
                        padding: 20px;
                        spacing: 15px;
                        
                        HorizontalBox {
                            alignment: space-between;
                            Text {
                                text: "Available Packages";
                                font-size: 18px;
                                font-weight: 700;
                            }
                            Rectangle {
                                width: 50px;
                                height: 30px;
                                border-radius: 15px;
                                background: #4CAF50;
                                HorizontalBox {
                                    alignment: center;
                                    Text {
                                        text: root.package_count;
                                        color: white;
                                        font-weight: 700;
                                    }
                                }
                            }
                        }
                        
                        Rectangle {
                            height: 1px;
                            background: #E0E0E0;
                        }
                        
                        ScrollView {
                            height: 500px;
                            VerticalBox {
                                spacing: 10px;
                                
                                for row in packages_data : Rectangle {
                                    height: 80px;
                                    border-radius: 8px;
                                    background: #FFFFFF;
                                    border-width: 2px;
                                    border-color: #E0E0E0;
                                    
                                    TouchArea {
                                        clicked => {}
                                    }
                                    
                                    HorizontalBox {
                                        padding: 15px;
                                        spacing: 15px;
                                        
                                        Rectangle {
                                            width: 60px;
                                            height: 60px;
                                            border-radius: 8px;
                                            background: #2196F3;
                                            VerticalBox {
                                                alignment: center;
                                                Text {
                                                    text: "APT";
                                                    color: white;
                                                    font-size: 10px;
                                                    font-weight: 700;
                                                }
                                                Text {
                                                    text: row[1].text;
                                                    color: white;
                                                    font-size: 18px;
                                                    font-weight: 700;
                                                }
                                            }
                                        }
                                        
                                        VerticalBox {
                                            spacing: 5px;
                                            alignment: center;
                                            
                                            HorizontalBox {
                                                Text {
                                                    text: "Package #" + row[2].text;
                                                    font-weight: 700;
                                                    font-size: 16px;
                                                }
                                            }
                                            
                                            Text {
                                                text: "Tracking: " + row[3].text;
                                                font-size: 12px;
                                                color: #666;
                                            }
                                            
                                            Text {
                                                text: "Received: " + row[4].text;
                                                font-size: 11px;
                                                color: #999;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                VerticalBox {
                    spacing: 20px;
                    
                    ElevatedCard {
                        height: 300px;
                        
                        VerticalBox {
                            padding: 30px;
                            alignment: center;
                            spacing: 20px;
                            
                            if root.verification_type == 0 : VerticalBox {
                                alignment: center;
                                spacing: 20px;
                                
                                Rectangle {
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 60px;
                                    background: #E3F2FD;
                                    
                                    VerticalBox {
                                        alignment: center;
                                        Text {
                                            text: "NFC";
                                            font-size: 60px;
                                        }
                                    }
                                }
                                
                                Text {
                                    text: "Tap Your Card";
                                    font-size: 24px;
                                    font-weight: 700;
                                    color: #1976D2;
                                }
                                
                                Text {
                                    text: "Place your NFC card on the reader";
                                    font-size: 14px;
                                    color: #666;
                                    horizontal-alignment: center;
                                }
                            }
                            
                            if root.verification_type == 1 : VerticalBox {
                                alignment: center;
                                spacing: 20px;
                                
                                Rectangle {
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 60px;
                                    background: #E8F5E9;
                                    
                                    VerticalBox {
                                        alignment: center;
                                        Text {
                                            text: "Check";
                                            font-size: 60px;
                                        }
                                    }
                                }
                                
                                Text {
                                    text: "Verified!";
                                    font-size: 24px;
                                    font-weight: 700;
                                    color: #4CAF50;
                                }
                                
                                Text {
                                    text: root.last_verified_name;
                                    font-size: 18px;
                                    color: #333;
                                    horizontal-alignment: center;
                                }
                                
                                Text {
                                    text: "Apartment " + root.last_verified_apt;
                                    font-size: 16px;
                                    color: #666;
                                    horizontal-alignment: center;
                                }
                            }
                            
                            if root.verification_type == 2 : VerticalBox {
                                alignment: center;
                                spacing: 20px;
                                
                                Rectangle {
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 60px;
                                    background: #FFEBEE;
                                    
                                    VerticalBox {
                                        alignment: center;
                                        Text {
                                            text: "Cross";
                                            font-size: 60px;
                                        }
                                    }
                                }
                                
                                Text {
                                    text: "Unknown Card";
                                    font-size: 24px;
                                    font-weight: 700;
                                    color: #F44336;
                                }
                                
                                Text {
                                    text: "Card not registered";
                                    font-size: 14px;
                                    color: #666;
                                    horizontal-alignment: center;
                                }
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 20px;
                        
                        ElevatedCard {
                            VerticalBox {
                                padding: 20px;
                                spacing: 10px;
                                alignment: center;
                                
                                Text {
                                    text: root.package_count;
                                    font-size: 32px;
                                    font-weight: 700;
                                    color: #2196F3;
                                }
                                
                                Text {
                                    text: "Pending Packages";
                                    font-size: 12px;
                                    color: #666;
                                }
                            }
                        }
                        
                        ElevatedCard {
                            VerticalBox {
                                padding: 20px;
                                spacing: 10px;
                                alignment: center;
                                
                                Text {
                                    text: "Today";
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #4CAF50;
                                }
                                
                                Text {
                                    text: "Collections";
                                    font-size: 12px;
                                    color: #666;
                                }
                            }
                        }
                    }
                    
                    ElevatedCard {
                        VerticalBox {
                            padding: 20px;
                            spacing: 15px;
                            
                            Text {
                                text: "How to Collect Packages";
                                font-weight: 700;
                                font-size: 16px;
                            }
                            
                            Rectangle {
                                height: 1px;
                                background: #E0E0E0;
                            }
                            
                            VerticalBox {
                                spacing: 10px;
                                
                                HorizontalBox {
                                    spacing: 10px;
                                    Text {
                                        text: "1.";
                                        font-weight: 700;
                                        width: 30px;
                                    }
                                    Text {
                                        text: "Resident taps their NFC card";
                                        font-size: 13px;
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 10px;
                                    Text {
                                        text: "2.";
                                        font-weight: 700;
                                        width: 30px;
                                    }
                                    Text {
                                        text: "System verifies apartment match";
                                        font-size: 13px;
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 10px;
                                    Text {
                                        text: "3.";
                                        font-weight: 700;
                                        width: 30px;
                                    }
                                    Text {
                                        text: "Packages automatically marked as collected";
                                        font-size: 13px;
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 10px;
                                    Text {
                                        text: "4.";
                                        font-weight: 700;
                                        width: 30px;
                                    }
                                    Text {
                                        text: "Transaction logged with timestamp";
                                        font-size: 13px;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // Main UI
    HorizontalBox {
        alignment: center;
        width: 100%;
        height: 100%;

        VerticalBox {
            padding: 20px;
            spacing: 20px;

            // Toolbar
            HorizontalBox {
                alignment: center;
                spacing: 20px;
                width: 1000px;
                height: 80px;

                VerticalBox {
                    width: 400px;
                    height: 56px;
                    alignment: center;
                    SegmentedButton {
                        items: [
                            { text: "People" },
                            { text: "Cards" },
                            { text: "Pack" },
                            { text: "Logs" }
                        ];
                        current-index <=> root.current_tab;
                        index_changed(index) => {
                            if (index == 0) {
                                table_columns = [
                                    {title: "ID"}, {title: "Apt"}, {title: "First Name"}, {title: "Last Name"}, {title: "Linked"}
                                ];
                                root.current_tab = index;
                                root.inventory = false;
                                show_residents_data();
                            } else if (index == 1) {
                                table_columns = [
                                    {title: "ID"}, {title: "Apt"}, {title: "Resident Name"}, {title: "Added Date"}
                                ];
                                root.current_tab = index;
                                root.inventory = false;
                                show_card_data();
                            } else if (index == 2) {
                                // Packages tab
                                table_columns = [
                                    {title: "ID"},
                                    {title: "Apt"},
                                    {title: "Pkg #"},
                                    {title: "Barcode"},
                                    {title: "Comment"}
                                ];
                                root.current_tab = index;
                                root.inventory = false;
                                show_packages_data();
                            } else if (index == 3) {
                                table_columns = [
                                    {title: "ID"}, {title: "Action Type"}, {title: "Action"}, {title: "Date Time"}
                                ];
                                root.current_tab = index;
                                root.inventory = false;
                                show_log_data();
                            }
                        }
                    }
                }

                VerticalBox {
                    alignment: center;
                    height: 56px;
                    SearchBar {
                        width: 280px;
                        height: 40px;
                        edited(text) => {
                            root.current_tab == 0 ? search_residents(text, root.current_tab) :
                            root.current_tab == 1 ? search_cards(text, root.current_tab) :
                            search_logs(text, root.current_tab);
                        };
                        accepted(text) => {
                            search_residents(text, root.current_tab);
                        }
                    }
                }
                
                VerticalBox {
                    alignment: center;
                    height: 56px;
                    HorizontalBox {
                        spacing: 20px;
                        IconButton {
                            width: 32px;
                            height: 32px;
                            icon: @image-url("icons/add_resident.svg");
                            tooltip: "Add resident";
                            clicked => {
                                root.show_resident_form = !root.show_resident_form;
                            }
                        }
                        IconButton {
                            width: 32px;
                            height: 32px;
                            icon: @image-url("icons/link_card.svg");
                            tooltip: "Link card";
                            clicked => {
                                root.show_link_card_form = !root.show_link_card_form;
                            }
                        }
                        IconButton {
                            width: 32px;
                            height: 32px;
                            icon: @image-url("icons/package.svg");
                            tooltip: "Add Package";
                            clicked => {
                                root.show_package_form = !root.show_package_form;
                            }
                        }
                        IconButton {
                            width: 32px;
                            height: 32px;
                            icon: root.inventory ? @image-url("icons/open_box.svg") : @image-url("icons/box.svg");
                            tooltip: "Inventory";
                            clicked => {
                                root.inventory = !root.inventory;
                            }
                        }
                        IconButton {
                            width: 32px;
                            height: 32px;
                            icon: @image-url("icons/cog.svg");
                            tooltip: "Config";
                            clicked => {}
                        }
                    }
                }
            }

            // Table
            HorizontalBox {
                alignment: center;
                StandardTableView {
                    min-width: 800px;
                    max-width: 800px;
                    visible: !root.inventory;
                    columns: root.table_columns;
                    rows: root.current_tab == 0 ? residents_data :
                          root.current_tab == 1 ? cards_data :
                          root.current_tab == 2 ? packages_data :
                          logs_data;
                    current-row-changed(index) => {
                        if (root.current_tab == 0) {
                            root.show_resident_info = true;
                            show_one_resident_info(index);
                        } else if (root.current_tab == 1) {
                            root.show_card_info = true;
                            show_one_card_info(index);
                        } else if (root.current_tab == 2) {
                            root.show_package_info = true;
                            show_one_package_info(index);
                        } else {
                            root.show_log_info = true;
                            show_one_log_info(index);
                        }
                    }
                }
            }
        }
    }
}